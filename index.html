<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uma Musume Track Selector</title>
    <style>
        :root {
            --bg-grad-start: #0f172a; --bg-grad-end: #1e1b4b;
            --glass-bg: rgba(30, 41, 59, 0.7); --border-col: rgba(148, 163, 184, 0.1);
            --primary: #10b981; --primary-glow: rgba(16, 185, 129, 0.4);
            --text-main: #f1f5f9; --text-muted: #94a3b8;
            --chip-bg: rgba(255,255,255,0.05); --btn-text: #fff;
        }
        [data-theme="ram"] {
            --bg-grad-start: #fff1f2; --bg-grad-end: #ffe4e6;
            --glass-bg: rgba(255, 255, 255, 0.85); --border-col: rgba(244, 63, 94, 0.2);
            --primary: #f43f5e; --primary-glow: rgba(244, 63, 94, 0.3);
            --text-main: #881337; --text-muted: #be123c; --chip-bg: rgba(244, 63, 94, 0.05);
        }
        [data-theme="rem"] {
            --bg-grad-start: #f0f9ff; --bg-grad-end: #e0f2fe;
            --glass-bg: rgba(255, 255, 255, 0.85); --border-col: rgba(14, 165, 233, 0.2);
            --primary: #0ea5e9; --primary-glow: rgba(14, 165, 233, 0.3);
            --text-main: #0c4a6e; --text-muted: #0369a1; --chip-bg: rgba(14, 165, 233, 0.05);
        }
        [data-theme="miku"] {
            --bg-grad-start: #111827; --bg-grad-end: #134e4a;
            --glass-bg: rgba(17, 24, 39, 0.8); --border-col: rgba(45, 212, 191, 0.2);
            --primary: #2dd4bf; --primary-glow: rgba(45, 212, 191, 0.4);
            --text-main: #ccfbf1; --text-muted: #5eead4; --chip-bg: rgba(45, 212, 191, 0.1);
        }
        [data-theme="teto"] {
            --bg-grad-start: #1c1917; --bg-grad-end: #450a0a;
            --glass-bg: rgba(28, 25, 23, 0.8); --border-col: rgba(225, 29, 72, 0.2);
            --primary: #e11d48; --primary-glow: rgba(225, 29, 72, 0.4);
            --text-main: #ffe4e6; --text-muted: #fda4af; --chip-bg: rgba(225, 29, 72, 0.1);
        }
        [data-theme="cappuchin"] {
            --bg-grad-start: #432818; --bg-grad-end: #5e3c27;
            --glass-bg: rgba(255, 248, 236, 0.95); --border-col: rgba(127, 85, 57, 0.2);
            --primary: #9c6644; --primary-glow: rgba(156, 102, 68, 0.3);
            --text-main: #432818; --text-muted: #7f5539; --chip-bg: rgba(156, 102, 68, 0.1);
        }
        [data-theme="macchiato"] {
            --bg-grad-start: #24273a; --bg-grad-end: #1e2030;
            --glass-bg: rgba(36, 39, 58, 0.8); --border-col: rgba(183, 189, 248, 0.1);
            --primary: #c6a0f6; --primary-glow: rgba(198, 160, 246, 0.4);
            --text-main: #cad3f5; --text-muted: #939ab7; --chip-bg: rgba(198, 160, 246, 0.1);
        }
        [data-theme="autumn"] {
            --bg-grad-start: #4c1d95; --bg-grad-end: #7c2d12;
            --glass-bg: rgba(255, 255, 255, 0.9); --border-col: rgba(124, 45, 18, 0.2);
            --primary: #ea580c; --primary-glow: rgba(234, 88, 12, 0.4);
            --text-main: #4c1d95; --text-muted: #7c2d12; --chip-bg: rgba(234, 88, 12, 0.1);
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end));
            height: 100vh; margin: 0; color: var(--text-main);
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .dashboard {
            display: grid; grid-template-columns: 320px 1fr; gap: 20px;
            width: 95vw; height: 90vh; max-width: 1400px;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--border-col); border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); padding: 20px; position: relative;
        }
        .sidebar {
            display: flex; flex-direction: column; gap: 15px;
            border-right: 1px solid var(--border-col); padding-right: 20px; overflow-y: auto;
        }
        .logo-area h1 {
            font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; margin: 0;
            color: var(--primary); border-bottom: 2px solid var(--primary);
            display: inline-block; padding-bottom: 5px; line-height: 1.4;
        }
        .control-group { background: rgba(0,0,0,0.05); padding: 12px; border-radius: 12px; }
        .label {
            display: block; font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;
        }
        .chip-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip { cursor: pointer; position: relative; flex: 1 1 auto; }
        .chip input { display: none; }
        .chip span {
            display: flex; justify-content: center; padding: 6px 10px;
            background: var(--chip-bg); border: 1px solid transparent; border-radius: 6px;
            font-size: 0.8rem; font-weight: 600; transition: all 0.2s; color: var(--text-muted);
        }
        .chip input:checked + span {
            background: var(--primary); color: var(--btn-text); box-shadow: 0 0 10px var(--primary-glow);
        }
        .theme-select {
            width: 100%; padding: 8px; background: var(--chip-bg);
            border: 1px solid var(--border-col); color: var(--text-main);
            border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin-top: 5px;
        }
        .theme-select option { background: var(--bg-grad-start); color: var(--text-main); }
        .main-stage {
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; position: relative;
        }
        .main-stage::before {
            content: 'UMA MUSUME'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 8vw; font-weight: 900;
            opacity: 0.03; pointer-events: none; white-space: nowrap;
        }
        .track-display {
            font-size: 3.5rem; font-weight: 800; line-height: 1.1; margin: 0;
            color: var(--text-main); transition: filter 0.1s; max-width: 900px;
        }
        .rolling .track-display { filter: blur(5px); opacity: 0.7; }
        .meta-tags {
            display: flex; gap: 10px; margin-top: 20px; opacity: 0;
            transform: translateY(20px); transition: all 0.5s ease;
        }
        .main-stage.show .meta-tags { opacity: 1; transform: translateY(0); }
        .badge {
            padding: 8px 16px; border-radius: 8px; font-size: 0.9rem;
            font-weight: 700; text-transform: uppercase;
            border: 1px solid var(--primary); color: var(--primary); background: var(--chip-bg);
        }
        .badge.highlight { background: var(--primary); color: var(--btn-text); }
        .conditions {
            margin-top: 30px; font-size: 1.5rem; font-weight: 300;
            color: var(--text-muted); opacity: 0; transition: opacity 0.5s ease 0.2s;
        }
        .main-stage.show .conditions { opacity: 1; }
        .cond-hl { color: var(--text-main); font-weight: 600; border-bottom: 2px solid var(--primary); }
        .roll-btn {
            margin-top: auto; padding: 15px; border: none; border-radius: 12px;
            background: var(--primary); color: var(--btn-text); font-size: 1.2rem;
            font-weight: 800; text-transform: uppercase; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .roll-btn:active { transform: translateY(4px); box-shadow: none; }
        .roll-btn:disabled { filter: grayscale(1); cursor: not-allowed; }
        #confetti {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
        }
        @media (max-width: 900px) {
            body { overflow: auto; height: auto; display: block; }
            .dashboard {
                display: flex; flex-direction: column-reverse;
                height: auto; min-height: 100vh; width: 100%; border-radius: 0;
            }
            .sidebar { border-right: none; border-top: 1px solid var(--border-col); padding-top: 20px; }
            .track-display { font-size: 2rem; }
        }
    </style>
</head>
<body>

<canvas id="confetti"></canvas>

<div class="dashboard">
    <aside class="sidebar">
        <div class="logo-area">
            <h1>Uma Musume<br>Track Selector</h1>
        </div>
        <div class="control-group">
            <span class="label">Theme</span>
            <select class="theme-select" id="themeSelect" onchange="changeTheme()">
                <option value="default">Default (Dark)</option>
                <option value="ram">Ram (Pink/White)</option>
                <option value="rem">Rem (Blue/White)</option>
                <option value="miku">Miku (Teal/Dark)</option>
                <option value="teto">Teto (Red/Charcoal)</option>
                <option value="cappuchin">Cappuchin (Coffee)</option>
                <option value="macchiato">Macchiato (Pastel/Dark)</option>
                <option value="autumn">Lavender & Orange</option>
            </select>
        </div>
        <div class="control-group">
            <span class="label">Surface</span>
            <div class="chip-grid" id="terrainFilter">
                <label class="chip"><input type="checkbox" value="Turf" checked><span>Turf</span></label>
                <label class="chip"><input type="checkbox" value="Dirt" checked><span>Dirt</span></label>
            </div>
        </div>
        <div class="control-group">
            <span class="label">Distance</span>
            <div class="chip-grid" id="catFilter">
                <label class="chip"><input type="checkbox" value="Sprint" checked><span>Sprint</span></label>
                <label class="chip"><input type="checkbox" value="Mile" checked><span>Mile</span></label>
                <label class="chip"><input type="checkbox" value="Medium" checked><span>Medium</span></label>
                <label class="chip"><input type="checkbox" value="Long" checked><span>Long</span></label>
            </div>
        </div>
        <div class="control-group">
            <span class="label">Direction</span>
            <div class="chip-grid" id="dirFilter">
                <label class="chip"><input type="checkbox" value="Right" checked><span>Right</span></label>
                <label class="chip"><input type="checkbox" value="Left" checked><span>Left</span></label>
                <label class="chip"><input type="checkbox" value="Stretch" checked><span>Straight</span></label>
            </div>
        </div>
        <div class="control-group">
            <span class="label">Track Capacity (Max Runners)</span>
            <div class="chip-grid" id="capFilter">
                <label class="chip"><input type="checkbox" value="18" checked><span>18</span></label>
                <label class="chip"><input type="checkbox" value="16" checked><span>16</span></label>
                <label class="chip"><input type="checkbox" value="15" checked><span>15</span></label>
                <label class="chip"><input type="checkbox" value="14" checked><span>14</span></label>
            </div>
        </div>
        <button class="roll-btn" id="rollBtn" onclick="startRoll()">ROLL TRACK</button>
    </aside>

    <main class="main-stage" id="mainStage">
        <h2 class="track-display" id="resultTitle">READY</h2>
        <div class="meta-tags" id="resultMeta"></div>
        <div class="conditions" id="resultCond"></div>
    </main>
</div>

<script>
    const STORAGE_KEY = 'uma_track_selector';
    const Audio = {
        ctx: null,
        init: function() {
            if (!this.ctx) { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
            if (this.ctx.state === 'suspended') { this.ctx.resume(); }
        },
        playTick: function() {
            if(!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(800, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, this.ctx.currentTime + 0.05);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + 0.05);
        },
        playFanfare: function() {
            if(!this.ctx) return;
            const now = this.ctx.currentTime;
            const notes = [523.25, 659.25, 783.99, 1046.50]; 
            notes.forEach((freq, i) => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.value = freq;
                const startTime = now + (i * 0.08); const stopTime = startTime + 0.8;
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.1, startTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, stopTime);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(startTime); osc.stop(stopTime);
            });
        }
    };

    function changeTheme() {
        const theme = document.getElementById('themeSelect').value;
        theme === 'default' ? document.documentElement.removeAttribute('data-theme') : document.documentElement.setAttribute('data-theme', theme);
        saveState();
    }

    const rawData = [
        "Sapporo Turf 2600m (Long) Right Max Runners:14", "Sapporo Turf 2000m (Medium) Right Max Runners:16",
        "Sapporo Turf 1800m (Mile) Right Max Runners:14", "Sapporo Turf 1500m (Mile) Right Max Runners:14",
        "Sapporo Turf 1200m (Sprint) Right Max Runners:16", "Sapporo Dirt 1700m (Mile) Right Max Runners:14",
        "Hakodate Turf 2600m (Long) Right Max Runners:16", "Hakodate Turf 2000m (Medium) Right Max Runners:16",
        "Hakodate Turf 1800m (Mile) Right Max Runners:16", "Hakodate Turf 1200m (Sprint) Right Max Runners:16",
        "Hakodate Turf 1000m (Sprint) Right Max Runners:14", "Hakodate Dirt 1700m (Mile) Right Max Runners:14",
        "Fukushima Turf 2600m (Long) Right Max Runners:16", "Fukushima Turf 2000m (Medium) Right Max Runners:16",
        "Fukushima Turf 1800m (Mile) Right Max Runners:16", "Fukushima Turf 1200m (Sprint) Right Max Runners:14",
        "Fukushima Dirt 1700m (Mile) Right Max Runners:15", "Fukushima Dirt 1150m (Sprint) Right Max Runners:16",
        "Niigata Turf 2400m (Medium) Left/Inner Max Runners:18", "Niigata Turf 2200m (Medium) Left/Inner Max Runners:18",
        "Niigata Turf 2000m (Medium) Left/Outer Max Runners:18", "Niigata Turf 2000m (Medium) Left/Inner Max Runners:18",
        "Niigata Turf 1800m (Mile) Left/Outer Max Runners:18", "Niigata Turf 1600m (Mile) Left/Outer Max Runners:18",
        "Niigata Turf 1400m (Mile) Left/Inner Max Runners:18", "Niigata Turf 1200m (Sprint) Left/Inner Max Runners:18",
        "Niigata Turf 1000m (Sprint) Stretch Max Runners:18", "Niigata Dirt 1800m (Mile) Left Max Runners:15",
        "Niigata Dirt 1200m (Sprint) Left Max Runners:15", "Tokyo Turf 3200m (Long) Left Max Runners: 18",
        "Tokyo Turf 2500m (Long) Left Max Runners: 18", "Tokyo Turf 2400m (Medium) Left Max Runners: 18",
        "Tokyo Turf 2300m (Medium) Left Max Runners: 18", "Tokyo Turf 2000m (Medium) Left Max Runners: 18",
        "Tokyo Turf 1800m (Mile) Left Max Runners: 18", "Tokyo Turf 1600m (Mile) Left Max Runners: 18",
        "Tokyo Turf 1400m (Mile) Left Max Runners: 18", "Tokyo Dirt 2100m (Medium) Left Max Runners:16",
        "Tokyo Dirt 1600m (Mile) Left Max Runners:16", "Tokyo Dirt 1400m (Sprint) Left Max Runners:16",
        "Tokyo Dirt 1300m (Sprint) Left Max Runners:16", "Nakayama Turf 3600m (Long) Right/Inner Max Runners:16",
        "Nakayama Turf 2500m (Long) Right/Inner Max Runners:16", "Nakayama Turf 2200m (Medium) Right/Outer Max Runners:18",
        "Nakayama Turf 2000m (Medium) Right/Inner Max Runners:18", "Nakayama Turf 1800m (Mile) Right/Inner Max Runners:16",
        "Nakayama Turf 1600m (Mile) Right/Outer Max Runners:16", "Nakayama Turf 1200m (Sprint) Right/Outer Max Runners:16",
        "Nakayama Dirt 1800m (Mile) Right Max Runners:16", "Nakayama Dirt 1200m (Sprint) Right Max Runners:16",
        "Chukyo Turf 2200m (Medium) Left Max Runners:18", "Chukyo Turf 2000m (Medium) Left Max Runners:18",
        "Chukyo Turf 1600m (Mile) Left Max Runners:16", "Chukyo Turf 1400m (Sprint) Left Max Runners:18",
        "Chukyo Turf 1200m (Sprint) Left Max Runners:18", "Chukyo Dirt 1800m (Mile) Left Max Runners:16",
        "Chukyo Dirt 1400m (Sprint) Left Max Runners:16", "Kyoto Turf 3200m (Long) Right/Outer Max Runners:18",
        "Kyoto Turf 3000m (Long) Right/Outer Max Runners:18", "Kyoto Turf 2400m (Medium) Right/Outer Max Runners:18",
        "Kyoto Turf 2200m (Medium) Right/Outer Max Runners:18", "Kyoto Turf 2000m (Medium) Right/Inner Max Runners:18",
        "Kyoto Turf 1800m (Mile) Right/Outer Max Runners:18", "Kyoto Turf 1600m (Mile) Right/Outer Max Runners:18",
        "Kyoto Turf 1600m (Mile) Right/Inner Max Runners:18", "Kyoto Turf 1400m (Sprint) Right/Outer Max Runners:18",
        "Kyoto Turf 1400m (Sprint) Right/Inner Max Runners:18", "Kyoto Turf 1200m (Sprint) Right/Inner Max Runners:18",
        "Kyoto Dirt 1900m (Medium) Right Max Runners:16", "Kyoto Dirt 1800m (Mile) Right Max Runners:16",
        "Kyoto Dirt 1400m (Sprint) Right Max Runners:16", "Kyoto Dirt 1200m (Sprint) Right Max Runners:16",
        "Hanshin Turf 3200m (Long) Right/Outerâ†’Inner Max Runners:18", "Hanshin Turf 3000m (Long) Right/Inner Max Runners:16",
        "Hanshin Turf 2600m (Long) Right/Outer Max Runners:18", "Hanshin Turf 2400m (Medium) Right/Outer Max Runners:18",
        "Hanshin Turf 2200m (Medium) Right/Inner Max Runners:18", "Hanshin Turf 2000m (Medium) Right/Inner Max Runners:16",
        "Hanshin Turf 1800m (Mile) Right/Outer Max Runners:18", "Hanshin Turf 1600m (Mile) Right/Outer Max Runners:18",
        "Hanshin Turf 1400m (Sprint) Right/Inner Max Runners:18", "Hanshin Turf 1200m (Sprint) Right/Inner Max Runners:16",
        "Hanshin Dirt 2000m (Medium) Right Max Runners:16", "Hanshin Dirt 1800m (Mile) Right Max Runners:16",
        "Hanshin Dirt 1400m (Sprint) Right Max Runners:16", "Kokura Turf 2600m (Long) Right Max Runners:16",
        "Kokura Turf 2000m (Medium) Right Max Runners:18", "Kokura Turf 1800m (Mile) Right Max Runners: 16",
        "Kokura Turf 1200m (Sprint) Right Max Runners:18", "Kokura Dirt 1700m (Mile) Right Max Runners:16",
        "Oi Dirt 2000m (Medium) Right Max Runners:16", "Oi Dirt 1800m (Mile) Right Max Runners:16",
        "Oi Dirt 1200m (Sprint) Right Max Runners:16"
    ];

    const seasons = ["Spring", "Summer", "Fall", "Winter"];
    const nonSnowyWeather = ["Sunny / Firm", "Sunny / Good", "Cloudy / Firm", "Cloudy / Good", "Rainy / Soft", "Rainy / Heavy"];
    const snowyWeather = ["Snowy / Good", "Snowy / Soft"];

    function parseTracks(data) {
        return data.map(line => {
            const parts = line.split(" ");
            const location = parts[0]; const surface = parts[1]; const distance = parts[2];
            const category = (line.match(/\((.*?)\)/) || [])[1] || "";
            let fullDirection = "Right";
            if(line.includes("Left")) fullDirection="Left";
            if(line.includes("Stretch")) fullDirection="Stretch";
            const dirMatch = line.match(/(Right|Left|Stretch)[\/\w\u2192]*/);
            if(dirMatch) fullDirection = dirMatch[0];
            const maxRunners = (line.match(/Max Runners:\s*(\d+)/) || [])[1];
            return {
                name: `${location} ${surface} ${distance}`, surface, distance, category,
                direction: fullDirection.includes("Left") ? "Left" : fullDirection.includes("Stretch") ? "Stretch" : "Right",
                fullDirection, maxRunners: maxRunners ? parseInt(maxRunners) : 16
            };
        });
    }

    const allTracks = parseTracks(rawData);
    function getCheckedValues(id) { return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb => cb.value); }

    function startRoll() {
        Audio.init();
        const btn = document.getElementById('rollBtn'); const stage = document.getElementById('mainStage');
        const title = document.getElementById('resultTitle');
        const terrain = getCheckedValues('terrainFilter');
        const cat = getCheckedValues('catFilter');
        const dir = getCheckedValues('dirFilter');
        const caps = getCheckedValues('capFilter').map(Number);

        const pool = allTracks.filter(t => 
            terrain.includes(t.surface) && cat.includes(t.category) && 
            dir.some(d => t.direction.includes(d)) && caps.includes(t.maxRunners)
        );

        if(pool.length === 0) { title.innerText = "NO MATCHES"; stage.classList.remove('show'); return; }

        btn.disabled = true; btn.innerText = "Rolling..."; stage.classList.remove('show'); stage.classList.add('rolling');
        let counter = 0; const maxIter = 25; let speed = 50;
        function step() {
            title.innerText = pool[Math.floor(Math.random() * pool.length)].name;
            Audio.playTick();
            if(counter < maxIter) {
                counter++;
                if(counter > 15) speed += 20; if(counter > 20) speed += 40;
                setTimeout(step, speed);
            } else { finalize(pool); }
        }
        step();
    }

    function finalize(pool) {
        const btn = document.getElementById('rollBtn'); const stage = document.getElementById('mainStage');
        const title = document.getElementById('resultTitle'); const meta = document.getElementById('resultMeta');
        const cond = document.getElementById('resultCond');
        const finalTrack = pool[Math.floor(Math.random() * pool.length)];
        const finalSeason = seasons[Math.floor(Math.random() * seasons.length)];
        const availableWeather = finalSeason === "Winter" ? nonSnowyWeather.concat(snowyWeather) : nonSnowyWeather;
        const finalWeather = availableWeather[Math.floor(Math.random() * availableWeather.length)];

        stage.classList.remove('rolling'); title.innerText = finalTrack.name;
        meta.innerHTML = `
            <span class="badge">${finalTrack.surface}</span> <span class="badge">${finalTrack.distance}</span>
            <span class="badge">${finalTrack.category}</span> <span class="badge">${finalTrack.fullDirection}</span>
            <span class="badge highlight">Max: ${finalTrack.maxRunners}</span>
        `;
        cond.innerHTML = `<span class="cond-hl">${finalSeason}</span> with <span class="cond-hl">${finalWeather}</span>`;
        stage.classList.add('show');
        fireConfetti(); Audio.playFanfare();
        setTimeout(() => { btn.disabled = false; btn.innerText = "ROLL TRACK"; }, 800);
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        const particles = Array.from({length: 80}, () => ({
            x: window.innerWidth/2, y: window.innerHeight/2, r: Math.random()*6+2,
            dx: (Math.random()-0.5)*25, dy: (Math.random()-0.5)*25, color: color, life: 100
        }));
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height); let active = false;
            particles.forEach(p => {
                if(p.life > 0) {
                    active = true; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.life/100; ctx.fill();
                    p.x+=p.dx; p.y+=p.dy; p.dy+=0.5; p.life--; p.r*=0.96;
                }
            });
            if(active) requestAnimationFrame(animate); else ctx.clearRect(0,0,canvas.width,canvas.height);
        }
        animate();
    }

    function saveState() {
        const state = {
            theme: document.getElementById('themeSelect').value,
            terrain: getCheckedValues('terrainFilter'),
            cat: getCheckedValues('catFilter'),
            dir: getCheckedValues('dirFilter'),
            caps: getCheckedValues('capFilter')
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        try {
            const state = JSON.parse(saved);
            if(state.theme) {
                document.getElementById('themeSelect').value = state.theme;
                changeTheme();
            }
            const setChecks = (id, values) => {
                if(!values) return;
                document.querySelectorAll(`#${id} input`).forEach(cb => {
                    cb.checked = values.includes(cb.value);
                });
            };
            setChecks('terrainFilter', state.terrain);
            setChecks('catFilter', state.cat);
            setChecks('dirFilter', state.dir);
            setChecks('capFilter', state.caps);
        } catch (e) {
            console.error("Failed to load state", e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('change', saveState);
        });
    });

</script>
</body>
</html>